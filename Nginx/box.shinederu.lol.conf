# à mettre dans ton vhost (site pour box.shinederu.lol)

# Map pour indiquer à PHP si l'orig était HTTPS (depuis HAProxy)
map $http_x_forwarded_proto $fastcgi_https {
  default off;
  https   on;
}

server {
  listen 89;
  listen [::]:89;
  server_name box.shinederu.lol;

  client_max_body_size 20480m;
  client_body_timeout 3600s;
  send_timeout 3600s;

  root /var/www/html/box.shinederu.lol/public;
  index index.html;

  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy same-origin always;
  add_header X-Frame-Options SAMEORIGIN always;

  # API PHP (hors webroot) via alias
  location ^~ /api/ {
    alias /var/www/html/box.shinederu.lol/api/;

    # Exécuter uniquement les .php ici
    location ~ \.php$ {
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME $request_filename;
      fastcgi_param DOCUMENT_ROOT   $realpath_root;

      # Indiquer le schéma et l'état HTTPS à PHP/FPM
      fastcgi_param REQUEST_SCHEME  $http_x_forwarded_proto;
      fastcgi_param HTTPS           $fastcgi_https;

      fastcgi_pass unix:/run/php/php8.3-fpm.sock;
      fastcgi_read_timeout 3600s;
    }

    # Interdire tout ce qui n'est pas .php
    location /api/ { return 404; }
  }

  # Téléchargements directs (jamais de PHP ici)
  location ^~ /uploads/ {
    autoindex off;
    types { }                           # vide => tout en octet-stream
    default_type application/octet-stream;
    add_header Content-Disposition "attachment";
    add_header X-Content-Type-Options nosniff;

    location ~ \.php$ { return 403; }
    try_files $uri =404;

    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
  }

  # Front
  location / { try_files $uri /index.html; }

  # Assets (optionnel)
  location ~* \.(css|js|woff2?|ttf|eot|ico|png|jpg|jpeg|gif|svg)$ {
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
    try_files $uri =404;
  }

  # Healthcheck (pratique pour HAProxy)
  location = /health { return 200 "ok\n"; add_header Content-Type text/plain; }

  error_page 404 /index.html;
}
